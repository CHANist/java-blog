<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M8C2S5R5VN"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-M8C2S5R5VN",{})</script><title data-react-helmet="true">1. Spring底层核心原理解析 | A Programmer&#x27;s Blog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://java.chanist.com/spring_advanced/bean_core_analysis"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="1. Spring底层核心原理解析 | A Programmer&#x27;s Blog"><meta data-react-helmet="true" name="description" content="课程内容："><meta data-react-helmet="true" property="og:description" content="课程内容："><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://java.chanist.com/spring_advanced/bean_core_analysis"><link data-react-helmet="true" rel="alternate" href="https://java.chanist.com/spring_advanced/bean_core_analysis" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://java.chanist.com/spring_advanced/bean_core_analysis" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.af64295e.css">
<link rel="preload" href="/assets/js/runtime~main.55ca59f1.js" as="script">
<link rel="preload" href="/assets/js/main.7fa852fa.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title">CHANist</b></a><a class="navbar__item navbar__link" href="/spring/factory_bean">Spring</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/spring_advanced/bean_core_analysis">Advanced Spring</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/spring_advanced/bean_core_analysis">1. Spring底层核心原理解析</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/spring_advanced/handwriting_simple_spring">2. 手写模拟Spring底层原理</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/spring_advanced/bean_core_concept_analysis">3. Spring之底层架构核心概念解析</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/spring_advanced/bean_lifecycle_first">bean_lifecycle_first</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>1. Spring底层核心原理解析</h1></header><blockquote><p>课程内容：</p><ol><li>Bean的生命周期底层原理</li><li>依赖注入底层原理</li><li>初始化底层原理</li><li>推断构造方法底层原理</li><li>AOP底层原理</li><li>Spring事务底层原理</li></ol></blockquote><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="bean-creation-life-cycle"></a>Bean Creation Life Cycle<a class="hash-link" href="#bean-creation-life-cycle" title="Direct link to heading">#</a></h3><p>--&gt; Scan through the package, and see @Service in <code>UserService</code>
Alternatively, can be using XML</p><p>--&gt; Constructor (decide which constructor to use)
--&gt; object created by Spring</p><p>--&gt; dependency injected (through property) [e.g. through annotation <code>@Autowired</code>]</p><p>--&gt; before initialization [<code>@PostConstruct</code>]</p><p>--&gt; initializing bean</p><p>--&gt; after initialization [use e.g. in <code>Spring AOP</code>]</p><p>--&gt; Proxy Object Bean </p><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="how-to-inject-property-value-into-an-object"></a>How to inject property value into an Object?<a class="hash-link" href="#how-to-inject-property-value-into-an-object" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// assume bean is the object bean created by Spring</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for (Field field: bean.getClass().getFields()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (field.isAnnotationPresent(Autowired.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        field.set(bean, ??);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>where ?? is the object reference to be set to the field.
So what remains are where the object reference is, how can we get that. This is beyond today&#x27;s topic though. We will have a more in-depth look later.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="how-to-trigger-postconstruct-method"></a>How to trigger @PostConstruct method?<a class="hash-link" href="#how-to-trigger-postconstruct-method" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// assume bean is the object bean created by Spring</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for (Method method: bean.getClass().getMethods()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (method.isAnnotationPresent(PostConstruct.class)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // as PostConstruct should carry no arguments at all,,,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        method.invoke(bean, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="designing-which-constructor-to-be-called"></a>Designing which Constructor to be called<a class="hash-link" href="#designing-which-constructor-to-be-called" title="Direct link to heading">#</a></h3><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="brief-understanding-of-spring-aop"></a>Brief Understanding of Spring AOP<a class="hash-link" href="#brief-understanding-of-spring-aop" title="Direct link to heading">#</a></h3><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="brief-understanding-of-spring-transaction-management"></a>Brief Understanding of Spring Transaction Management<a class="hash-link" href="#brief-understanding-of-spring-transaction-management" title="Direct link to heading">#</a></h3><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="dummy-notes"></a>Dummy Notes<a class="hash-link" href="#dummy-notes" title="Direct link to heading">#</a></h3><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912131115437.png" alt="image-20210912131115437"></p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912123146443.png" alt="image-20210912123146443"></p><p>Always go for no argument constructor if possible. </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912124027590.png" alt="image-20210912124027590"></p><p>If only has one constructor, with parameter, Spring will try to get a bean with such class and pass it to you. Therefore it will pass with value!!! </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="questions"></a>Questions<a class="hash-link" href="#questions" title="Direct link to heading">#</a></h3><p>So when should I use @Autowired, and when should I use constructor injection?</p><p>In case, if OrderService is not registered as a Spring bean, then instead of passing a null parameter to UserService, it will throw Exception instead.</p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912124556850.png" alt="image-20210912124556850"></p><p>It will be injected based on Java type. In case there are multiple ones, it will choose the one with the same bean name. In case if the there are no corresponding one, e.g. convert it to <code>orderService123</code>, it will throw Exception. </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912130723537.png" alt="image-20210912130723537"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="question"></a>Question<a class="hash-link" href="#question" title="Direct link to heading">#</a></h3><p>Isn&#x27;t Java will encrypt the parameter name when compiled, so will the logic work when we compile our java into .class files? </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912131005813.png" alt="image-20210912131005813"></p><p>it will create bean name based on the method name. So this bean will override the @Component one, and this will have the same object reference. </p><p>Further Work:
Try to validate this. </p><p>Of course, if there are multiple constructor, we can tell Spring which one to use, by specifying @Autowired in the constructor. </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912131354137.png" alt="image-20210912131354137"></p><p>@Autowired is the same, it will first try by type, then by name, to do injection.qw</p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912133238189.png" alt="image-20210912133238189"></p><p>Using AOP</p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912133404443.png" alt="image-20210912133404443"></p><p>How would it behaved? </p><p>We will get a Proxy （代理）</p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912145103511.png" alt="image-20210912145103511"></p><p>As it just extends the original UserService, therefore, OrderService does not have any value at this stage. </p><p>In order to have data in UserService, instead of calling  super.test(), we are going to use Dependency Injection, and inject the original UserService. </p><p>This is indeed the way, how Proxy works, and this also shows why it does not have OrderService in the Proxy, but it works. </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912150302860.png" alt="image-20210912150302860"></p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912145818297.png" alt="image-20210912145818297"></p><p>Aspect is a form of Bean as well, as can be seend from @Component. </p><p>And you can create a lot of methods to 切一個方法。
-&gt; 找回所有切面bean</p><p>-&gt; iterate all these beans</p><p>-&gt; place it in a map for cache first</p><p>So that when we create an AOP Proxy, we can create 1 Proxy and do all the 切面 before / after the method. </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912151151863.png" alt="image-20210912151151863"></p><hr><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="transactional-management"></a>Transactional Management<a class="hash-link" href="#transactional-management" title="Direct link to heading">#</a></h3><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912151600657.png" alt="image-20210912151600657"></p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912151649303.png" alt="image-20210912151649303"></p><p>-&gt; Data is inserted into the database unexpectedly, this is due to lack of @Configuration in AppConifg. </p><p>We will tell you why it does not work when @Configuration is not used at that time. </p><p>Using @Transactional, actually uses AOP. But how does it work? </p><ol><li>scan for @Trasactional </li><li>create a connection to database (using transactional manager, dataSource)</li><li>conn.autocommit = false, // as default is true, which will auto commit the MySQL statement to server, which will destroy the transaction. As transactional management means all or nothing. </li></ol><ol start="4"><li>it will auto create code, like
conn.commit();
conn.rollback(); </li></ol><p>Note that @Transactional also allow setting of Propagation, e.g.
Propagation.NEVER, // if a transaction already exists, then it cannot call the current method.  </p><p>Propagation.</p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912152409271.png" alt="image-20210912152409271"></p><p>Why it does not throw any exception?</p><p>As a(), is called by 普通方法，not calling the proxy one. As if it is not called by Proxy object, @Transactional(propagation) will not work. </p><p>-&gt; create another class and calling the other bean. As if calling another bean from @Autowired, it will be created by Spring bean. As the bean has @Transactional, it will create a proxy, which makes @Transactional(propagation) will work, and throw exception. </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912152726700.png" alt="image-20210912152726700"></p><p>But this sounds stupid, why creating another new class, instead we can solve it more easily, by @Autowired itself, so that the @Transactional will work as well.  </p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912152912036.png" alt="image-20210912152912036"></p><p>Question</p><p>Why if no @Configuration, it does not work?</p><p><img src="C:%5CUsers%5Chphch%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210912153135478.png" alt="image-20210912153135478"></p><p>Without @Configuration, it will create 2 different dataSource(), instead of reusing the same one. </p><blockquote><p>jdbcTemplate.exec(&quot;insert XXX&quot;); </p></blockquote><p>will work but as we did not change <code>conn.autocomit = false</code> </p><p>We need transactionManager to modify the datasource to <code>conn.autocommit = false</code> to make it work. </p><p>@Configuration ensures the 2 data sources are retrieving the same object. But how Spring ensures it to be the same data source, we will discuss it later. </p><p>This relates to Proxy Pattern 代理模式，it will first check if dataSource available, if not available, then it will create one, if it has one, it will reuse it. </p><hr></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/java">Java</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/spring">Spring</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/圖靈課堂">圖靈課堂</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2021-10-16T05:27:23.000Z">10/16/2021</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/spring_advanced/handwriting_simple_spring"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2. 手写模拟Spring底层原理 »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bean-creation-life-cycle" class="table-of-contents__link">Bean Creation Life Cycle</a></li><li><a href="#how-to-inject-property-value-into-an-object" class="table-of-contents__link">How to inject property value into an Object?</a></li><li><a href="#how-to-trigger-postconstruct-method" class="table-of-contents__link">How to trigger @PostConstruct method?</a></li><li><a href="#designing-which-constructor-to-be-called" class="table-of-contents__link">Designing which Constructor to be called</a></li><li><a href="#brief-understanding-of-spring-aop" class="table-of-contents__link">Brief Understanding of Spring AOP</a></li><li><a href="#brief-understanding-of-spring-transaction-management" class="table-of-contents__link">Brief Understanding of Spring Transaction Management</a></li><li><a href="#dummy-notes" class="table-of-contents__link">Dummy Notes</a></li><li><a href="#questions" class="table-of-contents__link">Questions</a></li><li><a href="#question" class="table-of-contents__link">Question</a></li><li><a href="#transactional-management" class="table-of-contents__link">Transactional Management</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Java Tutorial</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/spring/factory_bean">Spring</a></li><li class="footer__item"><a class="footer__link-item" href="/spring_advanced/bean_core_analysis">Advanced Spring</a></li></ul></div><div class="col footer__col"><div class="footer__title">About Me</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/users/3985356/chanist" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/CHANist" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 thechanist.com. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.55ca59f1.js"></script>
<script src="/assets/js/main.7fa852fa.js"></script>
</body>
</html>